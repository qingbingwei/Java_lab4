<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.studentscore.mapper.TeachingClassMapper">

    <!-- 分页查询教学班（带关联信息） -->
    <select id="selectTeachingClassPage" resultType="com.example.studentscore.vo.TeachingClassVO">
        SELECT
            tc.id,
            tc.class_id,
            COALESCE(c.course_id, '') AS course_id,
            COALESCE(c.course_name, '未关联课程') AS course_name,
            COALESCE(c.credits, 0) AS credits,
            COALESCE(t.teacher_id, '') AS teacher_id,
            COALESCE(t.name, '未分配教师') AS teacher_name,
            tc.semester,
            tc.capacity,
            tc.schedule_time,
            tc.classroom,
            (SELECT COUNT(*) FROM enrollment e WHERE e.teaching_class_db_id = tc.id AND e.deleted = 0) AS current_size,
            tc.create_time
        FROM teaching_class tc
        LEFT JOIN course c ON tc.course_db_id = c.id AND c.deleted = 0
        LEFT JOIN teacher t ON tc.teacher_db_id = t.id AND t.deleted = 0
        WHERE tc.deleted = 0
        <if test="query.classId != null and query.classId != ''">
            AND tc.class_id LIKE CONCAT('%', #{query.classId}, '%')
        </if>
        <if test="query.courseId != null and query.courseId != ''">
            AND c.course_id LIKE CONCAT('%', #{query.courseId}, '%')
        </if>
        <if test="query.courseName != null and query.courseName != ''">
            AND c.course_name LIKE CONCAT('%', #{query.courseName}, '%')
        </if>
        <if test="query.teacherId != null and query.teacherId != ''">
            AND t.teacher_id LIKE CONCAT('%', #{query.teacherId}, '%')
        </if>
        <if test="query.teacherName != null and query.teacherName != ''">
            AND t.name LIKE CONCAT('%', #{query.teacherName}, '%')
        </if>
        <if test="query.semester != null and query.semester != ''">
            AND tc.semester = #{query.semester}
        </if>
        <if test="query.keyword != null and query.keyword != ''">
            AND (
                tc.class_id LIKE CONCAT('%', #{query.keyword}, '%')
                OR c.course_name LIKE CONCAT('%', #{query.keyword}, '%')
                OR t.name LIKE CONCAT('%', #{query.keyword}, '%')
            )
        </if>
        ORDER BY tc.create_time DESC
    </select>

    <!-- 根据ID查询教学班详情 -->
    <select id="selectTeachingClassById" resultType="com.example.studentscore.vo.TeachingClassVO">
        SELECT
            tc.id,
            tc.class_id,
            COALESCE(c.course_id, '') AS course_id,
            COALESCE(c.course_name, '未关联课程') AS course_name,
            COALESCE(c.credits, 0) AS credits,
            COALESCE(t.teacher_id, '') AS teacher_id,
            COALESCE(t.name, '未分配教师') AS teacher_name,
            tc.semester,
            tc.capacity,
            tc.schedule_time,
            tc.classroom,
            (SELECT COUNT(*) FROM enrollment e WHERE e.teaching_class_db_id = tc.id AND e.deleted = 0) AS current_size,
            tc.create_time
        FROM teaching_class tc
        LEFT JOIN course c ON tc.course_db_id = c.id AND c.deleted = 0
        LEFT JOIN teacher t ON tc.teacher_db_id = t.id AND t.deleted = 0
        WHERE tc.id = #{id} AND tc.deleted = 0
    </select>

    <!-- 查询所有教学班列表（带关联信息） -->
    <select id="selectAllTeachingClasses" resultType="com.example.studentscore.vo.TeachingClassVO">
        SELECT
            tc.id,
            tc.class_id,
            COALESCE(c.course_id, '') AS course_id,
            COALESCE(c.course_name, '未关联课程') AS course_name,
            COALESCE(c.credits, 0) AS credits,
            COALESCE(t.teacher_id, '') AS teacher_id,
            COALESCE(t.name, '未分配教师') AS teacher_name,
            tc.semester,
            tc.capacity,
            tc.schedule_time,
            tc.classroom,
            (SELECT COUNT(*) FROM enrollment e WHERE e.teaching_class_db_id = tc.id AND e.deleted = 0) AS current_size,
            tc.create_time
        FROM teaching_class tc
        LEFT JOIN course c ON tc.course_db_id = c.id AND c.deleted = 0
        LEFT JOIN teacher t ON tc.teacher_db_id = t.id AND t.deleted = 0
        WHERE tc.deleted = 0
        ORDER BY tc.create_time DESC
    </select>

</mapper>
