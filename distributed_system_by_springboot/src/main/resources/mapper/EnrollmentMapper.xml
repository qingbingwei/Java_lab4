<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.studentscore.mapper.EnrollmentMapper">

    <!-- 查询学生选课列表（带关联信息） -->
    <select id="selectStudentEnrollments" resultType="com.example.studentscore.vo.EnrollmentVO">
        SELECT
            e.id,
            e.id AS enrollment_id,
            e.student_db_id,
            s.student_id,
            s.name AS student_name,
            e.teaching_class_db_id,
            tc.class_id,
            tc.class_id AS class_name,
            tc.course_db_id,
            COALESCE(c.course_id, '') AS course_code,
            COALESCE(c.course_name, '未关联课程') AS course_name,
            COALESCE(c.course_type, '') AS course_type,
            COALESCE(c.credits, 0) AS credit,
            tc.teacher_db_id,
            COALESCE(t.teacher_id, '') AS teacher_id,
            COALESCE(t.name, '未分配教师') AS teacher_name,
            tc.semester,
            COALESCE(tc.schedule_time, '') AS schedule,
            e.create_time AS enroll_time,
            'ENROLLED' AS status
        FROM enrollment e
        LEFT JOIN student s ON e.student_db_id = s.id AND s.deleted = 0
        LEFT JOIN teaching_class tc ON e.teaching_class_db_id = tc.id AND tc.deleted = 0
        LEFT JOIN course c ON tc.course_db_id = c.id AND c.deleted = 0
        LEFT JOIN teacher t ON tc.teacher_db_id = t.id AND t.deleted = 0
        WHERE e.deleted = 0 
            AND e.student_db_id = #{studentDbId}
        ORDER BY e.create_time DESC
    </select>

    <!-- 查询教学班学生列表（带关联信息） -->
    <select id="selectClassEnrollments" resultType="com.example.studentscore.vo.EnrollmentVO">
        SELECT
            e.id,
            e.id AS enrollment_id,
            e.student_db_id,
            s.student_id,
            s.name AS student_name,
            e.teaching_class_db_id,
            tc.class_id,
            tc.class_id AS class_name,
            tc.course_db_id,
            COALESCE(c.course_id, '') AS course_code,
            COALESCE(c.course_name, '未关联课程') AS course_name,
            COALESCE(c.course_type, '') AS course_type,
            COALESCE(c.credits, 0) AS credit,
            tc.teacher_db_id,
            COALESCE(t.teacher_id, '') AS teacher_id,
            COALESCE(t.name, '未分配教师') AS teacher_name,
            tc.semester,
            COALESCE(tc.schedule_time, '') AS schedule,
            e.create_time AS enroll_time,
            'ENROLLED' AS status
        FROM enrollment e
        LEFT JOIN student s ON e.student_db_id = s.id AND s.deleted = 0
        LEFT JOIN teaching_class tc ON e.teaching_class_db_id = tc.id AND tc.deleted = 0
        LEFT JOIN course c ON tc.course_db_id = c.id AND c.deleted = 0
        LEFT JOIN teacher t ON tc.teacher_db_id = t.id AND t.deleted = 0
        WHERE e.deleted = 0 
            AND e.teaching_class_db_id = #{teachingClassDbId}
        ORDER BY s.student_id ASC
    </select>

</mapper>
